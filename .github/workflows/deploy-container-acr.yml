name: Build & Deploy Container to Azure Web App (ACR)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  APP_NAME: ${{ vars.APP_SERVICE_NAME }} # e.g. nvd-proxy-dev
  RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }} # e.g. rg-dev
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }} # e.g. myregistry.azurecr.io
  IMAGE_NAME: nvd-proxy
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE: ./webapi/Dockerfile
  CONTEXT: ./webapi

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (via AZURE_CREDENTIALS)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # --- Terraform: Provision infrastructure before deploying the app ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: terraform/Terraform

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: terraform/Terraform

      - name: Terraform Apply (initial infra - env, ACR, identity)
        run: |
          terraform apply -auto-approve \
            -target azurerm_resource_group.unir \
            -target azurerm_log_analytics_workspace.logAnalytics \
            -target azurerm_container_app_environment.managedEnv20250828125507 \
            -target azurerm_container_registry.jsmacr15 \
            -target azurerm_user_assigned_identity.acr_pull \
            -target azurerm_role_assignment.acr_pull
        working-directory: terraform/Terraform

      - name: Login to ACR via Azure CLI
        run: |
          ACR_NAME=$(echo "${{ env.ACR_LOGIN_SERVER }}" | sed 's/.azurecr.io$//')
          az acr login -n "$ACR_NAME"

      - name: Build & Push image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKERFILE }}
          push: true
          tags: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # Update Container App with the built image tag
      - name: Terraform Apply (deploy container app revision)
        run: |
          terraform apply -auto-approve -var "image_tag=${{ env.IMAGE_TAG }}"
        working-directory: terraform/Terraform

      # Optional: If you still use App Service, keep these steps or remove if fully on Container Apps
      #- name: Point Web App to ACR image
      #  run: |
      #    az webapp config container set \
      #      -g "${{ env.RESOURCE_GROUP }}" \
      #      -n "${{ env.APP_NAME }}" \
      #      --docker-custom-image-name "${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
      #      --docker-registry-server-url "https://${{ env.ACR_LOGIN_SERVER }}"

      #- name: Restart Web App
      #  run: az webapp restart -g "${{ env.RESOURCE_GROUP }}" -n "${{ env.APP_NAME }}"

      - name: Logout Azure
        if: always()
        run: az logout
